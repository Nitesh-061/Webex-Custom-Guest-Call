<!DOCTYPE html>
<!--
Copyright (c) 2021 Cisco and/or its affiliates.

This software is licensed to you under the terms of the Cisco Sample
Code License, Version 1.1 (the "License"). You may obtain a copy of the
License at

               https://developer.cisco.com/docs/licenses

All use of the material herein must be in accordance with the terms of
the License. All rights not expressly granted by the License are
reserved. Unless required by applicable law or agreed to separately in
writing, software distributed under the License is distributed on an "AS
IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="locale" content="US">
    <meta name="language" content="en">
    <meta name="country" content="US">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Webex Teams Meetings Teleconsultation</title>
    <!--  <link href="{{ url_for('static', filename='CSS/style.css') }}" rel="stylesheet" type="text/css"> -->
    <link rel="icon" type="image/vnd.microsoft.icon" href="//www.cisco.com/favicon.ico">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="///www.cisco.com/favicon.ico">
    <link href="{{ url_for('static', filename='css/cui-styleguide.min.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='css/cui-standard.min.css') }}" rel="stylesheet" type="text/css">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>



</head>


    <body class="cui">
      <header class="header">
          <div class="container">
              <div class="header-panels">
                  <div class="header-panel">
                      <a class="header__logo" href="http://www.cisco.com" target="_blank">
                          <span class="icon-cisco"></span>
                      </a>
                      <div class="header__title">Expert Connect Sample</div>
                  </div>
              </div>
          </div>
      </header>
      <div class="content">
          <div class="container-fluid">
              <div class="section">
                  <div class="row">
                      <div class="panel no-padding container-fluid">
                          <div class="flex flex-center">
                              <div class="panel panel--bordered panel--raised qtr-margin hover-emboss--small">
                                  <div id="remote-video-div">
                                      <audio id="remote-view-audio" autoplay playsinline></audio>
                                      <video class="media" id="remote-view-video" autoplay playsinline
                                          style="min-height: 22em;max-height: 28em;"></video>
                                  </div>
                                  <div id="remote-content-div" style="display: none;">
                                      <video class="media" id="remote-screen" muted autoplay playsinline
                                          style="min-height: 22em;max-height: 28em;"></video>
                                  </div>
                              </div>
                          </div>
                          <div class="flex flex-center">
                              <div class="panel qtr-margin">
                                  <div class="row">
                                      <div id="self-view-div">
                                          <video class="media" id="self-view" muted autoplay playsinline
                                              style="min-height: 5em;max-height: 7em;"></video>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="panel panel--loose panel--bordered qtr-margin">
                              <div class="flex flex-around">
                                  <div class="col-3 visible-xs-up">
                                      <div class="flex flex-warp flex-right ">
                                          <div class="btn-group btn-group--square qtr-margin" role="group">
                                              <button type="button" class="btn btn--icon btn--success qtr-margin"
                                                  id="start-sending-audio" disabled><span
                                                      class="btn-icon icon-microphone"></span></button>
                                              <button type="button" class="btn btn--icon btn--negative qtr-margin"
                                                  id="stop-sending-audio" disabled><span
                                                      class="btn-icon icon-mute"></span></button>
                                              <button type="button" class="btn btn--icon btn--success qtr-margin"
                                                  id="start-sending-video" disabled><span
                                                      class="btn-icon icon-video"></span></button>
                                              <button type="button" class="btn btn--icon btn--negative qtr-margin"
                                                  id="stop-sending-video" disabled><span
                                                      class="btn-icon icon-video-cross"></span></button>
                                              <button type="button" class="btn btn--icon btn--primary qtr-margin"
                                                      id="low-bandwidth-mode" disabled><span
                                                          class="btn-icon icon-call-rate"></span></button>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-6">
                                      <div class="flex flex-wrap flex-center">
                                          <div class="btn-group" role="group">
                                              <button type="button" class="btn btn--large btn--justified btn--success"
                                                  id="call" disabled><span class="btn-icon icon-answer-oldest"></span>
                                                  Call</button>
                                              <button type="button" class="btn btn--large btn--justified btn--negative"
                                                  id="hangup" disabled><span
                                                      class="btn-icon icon-answer-oldest rotate-180"></span>
                                                  Hangup</button>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-3 hidden-sm-down">
                                      <div class="flex flex-wrap flex-left">
                                          <label class="label label--icon qtr-margin" data-balloon="off"
                                              data-balloon-pos="up" id="status"><span
                                                  class="icon icon-webex"></span></label>
                                          <!-- <label class="label label--icon qtr-margin" data-balloon="not-connected" data-balloon-pos="up" id="call-status-local"><span class="icon icon-new-call"></span></label> -->
                                          <label class="label label--icon qtr-margin" data-balloon="off"
                                              data-balloon-pos="up" id="microphone-state"><span
                                                  class="icon icon-microphone"></span></label>
                                          <label class="label label--icon qtr-margin" data-balloon="off"
                                              data-balloon-pos="up" id="camera-state"><span
                                                  class="icon icon-video"></span></label>
                                          <!-- <button type="button"  href="#" class="btn"><span class="icon-close"></span></button> -->
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
    </body>
    <script crossorigin src="https://unpkg.com/webex@^1/umd/webex.min.js"></script>
    <script>
const webex = window.Webex.init({
  config: {
          logger: {
            level: 'debug'
          },
          meetings: {
            reconnection: {
              enabled: true
            }
          }
          // Any other sdk config we need
        },
  credentials: {
    access_token: "{{ access_token }}"
  }
});

let meetingHasVideo = false;

function updateStatus(status) {
  document.getElementById('status').setAttribute('data-balloon', status);
}

webex.meetings.register().then(() => {
        //  Disable the button to connect call until all is propertly initialized  
        //document.getElementById('call').disabled = true;
        console.log("about to register the call button... ");

        document.getElementById('call').addEventListener('click', () => {
          const destination = decodeURIComponent('{{ destination_id|safe }}');
          console.log('Trying to call corrected destination: ',destination);

          // Create the meeting
          return webex.meetings.create(destination).then((meeting) => {
            // Pass the meeting to our join meeting helper
            updateStatus('Calling.');

            //meeting.setMeetingQuality('MEDIUM').then(); 
              
            joinMeeting(meeting);
            return bindMeetingEvents(meeting);

          });

        });

        updateStatus('Webex connected, waiting for expert...');
        document.getElementById('call').disabled = false;
      })
    .catch((err) => {
    console.error(err);
    alert(err);
    throw err;
  });

  function bindMeetingEvents(meeting) {
  // call is a call instance, not a promise, so to know if things break,
  // we'll need to listen for the error event. Again, this is a rather naive
  // handler.
  meeting.on('error', (err) => {
    console.error(err);
  });

  // Handle media streams changes to ready state
  meeting.on('media:ready', (media) => {
    if (!media) {
      return;
    }
    if (media.type === 'local') {
      document.getElementById('self-view').srcObject = media.stream;
      document.getElementById('microphone-state').setAttribute('data-balloon', 'on');
      document.getElementById('camera-state').setAttribute('data-balloon', 'on');
    }
    if (media.type === 'remoteVideo') {
      document.getElementById('remote-view-video').srcObject = media.stream;
    }
    if (media.type === 'remoteAudio') {
      document.getElementById('remote-view-audio').srcObject = media.stream;
    }
    if (media.type === 'remoteShare') {
      // Remote share streams become active immediately on join, even if nothing is being shared
      document.getElementById('remote-screen').srcObject = media.stream;
    }
  });

  // Handle media streams stopping
  meeting.on('media:stopped', (media) => {
    // Remove media streams
    if (media.type === 'local') {
      document.getElementById('self-view').srcObject = null;
      document.getElementById('microphone-state').setAttribute('data-balloon', 'off');
      document.getElementById('camera-state').setAttribute('data-balloon', 'off');
    }
    if (media.type === 'remoteVideo') {
      document.getElementById('remote-view-video').srcObject = null;
    }
    if (media.type === 'remoteAudio') {
      document.getElementById('remote-view-audio').srcObject = null;
    }
    if (media.type === 'remoteShare') {
      // Remote share streams become active immediately on join, even if nothing is being shared
      document.getElementById('remote-screen').srcObject = null;
    }
  });

  // Handler for content updates so we can show and hide the remote video
  // and content accordingly
  meeting.members.on('members:content:update', (payload) => {
    console.log(`who started sharing: ${payload.activeContentSharingId};`);
    console.log(`who stopped sharing: ${payload.endedContentSharingId};`);
    var theContentDiv = document.getElementById("remote-content-div");
    var theVideoDiv = document.getElementById("remote-video-div");

    if (payload.activeContentSharingId != null) {
      theContentDiv.style.display = "block";
      theVideoDiv.style.display = "none";
    }
    else {
      theContentDiv.style.display = "none";
      theVideoDiv.style.display = "block";
    }
  });

  document.getElementById('start-sending-audio').addEventListener('click', () => {
    if (meeting) {
      meeting.unmuteAudio().then(() => {
        document.getElementById('microphone-state').setAttribute('data-balloon', 'on');
      });
    }
  });

  document.getElementById('stop-sending-audio').addEventListener('click', () => {
    if (meeting) {
      meeting.muteAudio().then(() => {
        document.getElementById('microphone-state').setAttribute('data-balloon', 'off');
      });
    }
  });

  document.getElementById('start-sending-video').addEventListener('click', () => {

    if (meeting) {

      // Add video to the call only if it had not been added already by a previous
      // click on the Start Video button
      if (meetingHasVideo == false) {
        console.log("about to getMediaStreams()..");
        const mediaSettings = {
            receiveVideo: true,
            receiveAudio: true,
            receiveShare: true,
            sendVideo: false, // Start call with no video
            sendAudio: true,
            sendShare: false,
          };
        meeting.getMediaStreams(mediaSettings)
          .then(([localStream]) => { 

            meeting.updateAudio({
                stream: localStream,
                sendAudio: true,
                receiveAudio: true
              });
            meeting.updateVideo({
                stream: localStream,
                sendVideo: true,
                receiveVideo: true
              });
        }
          )
          .then(() => {
            meetingHasVideo = true;
          });

      }

      meeting.unmuteVideo().then(() => {
        document.getElementById('camera-state').setAttribute('data-balloon', 'on');
        document.getElementById('stop-sending-video').disabled = false;

      });
    }
  });

  document.getElementById('stop-sending-video').addEventListener('click', () => {
    if (meeting) {
      meeting.muteVideo().then(() => {
        document.getElementById('camera-state').setAttribute('data-balloon', 'off');

      });
    }
  });

  document.getElementById('low-bandwidth-mode').addEventListener('click', () => {
    if (meeting) {

      meeting.setMeetingQuality('LOW').then(() => {
        document.getElementById('camera-state').setAttribute('data-balloon', 'Low bandwidth mode enabled');
      });
    }
  });

  // Of course, we'd also like to be able to end the call:
  document.getElementById('hangup').addEventListener('click', () => {

    
    if (meeting) {

      meeting.leave().then(() => {
        document.getElementById('microphone-state').setAttribute('data-balloon', 'off');
        document.getElementById('camera-state').setAttribute('data-balloon', 'off');
        document.getElementById('hangup').disabled = true;
        document.getElementById('call').disabled = false;

        document.getElementById('stop-sending-video').disabled = true;
        document.getElementById('start-sending-audio').disabled = true;
        document.getElementById('stop-sending-audio').disabled = true;
        document.getElementById('start-sending-video').disabled = true;
        document.getElementById('low-bandwidth-mode').disabled = true;

        updateStatus('Disconnected.');

      });


    }

  });
}

// Join the meeting and add media
function joinMeeting(meeting) {
  return meeting.join().then(() => {
    document.getElementById('call').disabled = true;
    document.getElementById('hangup').disabled = false;
    document.getElementById('stop-sending-video').disabled = false;
    document.getElementById('start-sending-audio').disabled = false;
    document.getElementById('stop-sending-audio').disabled = false;
    document.getElementById('start-sending-video').disabled = false;
    document.getElementById('low-bandwidth-mode').disabled = false;
    document.getElementById('low-bandwidth-mode').setAttribute('data-balloon', 'Set low bandwidth mode');

    updateStatus('Connected to Expert');
    const mediaSettings = {
      receiveVideo: true,
      receiveAudio: true,
      receiveShare: true,
      sendVideo: false, // Start call with no video
      sendAudio: true,
      sendShare: false,
    };


    return meeting.getMediaStreams(mediaSettings).then((mediaStreams) => {
      const [localStream, localShare] = mediaStreams;

      meeting.addMedia({
        localShare,
        localStream,
        mediaSettings,
      });

    });
  });
}



    </script>
  </body>
</html>